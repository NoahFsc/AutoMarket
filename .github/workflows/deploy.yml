name: Deploy Site to Server

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install OpenVPN
      run: sudo apt-get update && sudo apt-get install -y openvpn

    - name: Setup VPN
      run: |
        sudo mkdir -p /etc/openvpn
        echo "${{ secrets.VPN_CONFIG }}" > config.ovpn
        sudo mv config.ovpn /etc/openvpn/config.ovpn
        echo -e "${{ secrets.ENT_USERNAME }}\n${{ secrets.ENT_PASSWORD }}" | sudo tee /etc/openvpn/ent_credentials > /dev/null
        sudo sed -i 's/auth-user-pass/auth-user-pass \/etc\/openvpn\/ent_credentials/' /etc/openvpn/config.ovpn
        sudo openvpn --config /etc/openvpn/config.ovpn --daemon

    - name: Setup SSH Key
      run: |
        echo "${{ secrets.SSH_KEY }}" > id_rsa
        sudo mv id_rsa ~/.ssh/id_rsa
        sudo chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H 10.1.138.4 >> ~/.ssh/known_hosts
        cat ~/.ssh/id_rsa # Afficher le contenu de la clé SSH pour vérification
        ls -l ~/.ssh # Vérifier les permissions des fichiers dans ~/.ssh

    - name: Deploy to server
      run: |
        ssh etudiant@10.1.138.4 << 'EOF'
          cd /home/etudiant/AutoMarket &&
          git pull &&
          docker-compose down &&
          docker-compose up -d --build
        EOF